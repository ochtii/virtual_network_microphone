<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIMIC Audio Stream Player</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        .container {
            background-color: #2d2d2d;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        h1 {
            text-align: center;
            color: #4CAF50;
            margin-bottom: 30px;
        }
        .stream-info {
            background-color: #333;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .stream-url {
            font-family: monospace;
            background-color: #444;
            padding: 10px;
            border-radius: 3px;
            word-break: break-all;
            margin: 10px 0;
        }
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 0 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #666;
            cursor: not-allowed;
        }
        .status {
            text-align: center;
            margin: 20px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .status.success {
            background-color: #4CAF50;
        }
        .status.error {
            background-color: #f44336;
        }
        .status.info {
            background-color: #2196F3;
        }
        audio {
            width: 100%;
            margin: 20px 0;
        }
        .method-selection {
            margin: 20px 0;
            text-align: center;
        }
        .method-selection label {
            margin: 0 15px;
            cursor: pointer;
        }
        .debug-info {
            background-color: #333;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé§ PIMIC Audio Stream Player</h1>
        
        <div class="stream-info">
            <h3>Stream Information</h3>
            <div>Stream URL: <div class="stream-url" id="streamUrl">Detecting...</div></div>
            <div>Status: <span id="streamStatus">Checking...</span></div>
        </div>

        <div class="method-selection">
            <h3>Playback Method:</h3>
            <label>
                <input type="radio" name="method" value="direct" checked>
                Direct Audio Element
            </label>
            <label>
                <input type="radio" name="method" value="websocket">
                WebSocket Stream
            </label>
            <label>
                <input type="radio" name="method" value="polling">
                HTTP Polling
            </label>
        </div>

        <div class="controls">
            <button id="playBtn" onclick="startPlayback()">‚ñ∂Ô∏è Start Playback</button>
            <button id="stopBtn" onclick="stopPlayback()" disabled>‚èπÔ∏è Stop Playback</button>
            <button onclick="refreshStream()">üîÑ Refresh</button>
        </div>

        <div id="status" class="status info">
            Ready to play audio stream
        </div>

        <audio id="audioPlayer" controls style="display: none;">
            Your browser does not support the audio element.
        </audio>

        <canvas id="visualizer" width="800" height="100" style="background: #444; margin: 20px 0; display: none;"></canvas>

        <div class="debug-info">
            <h4>Debug Log:</h4>
            <div id="debugLog"></div>
        </div>
    </div>

    <script>
        let audioContext = null;
        let audioSource = null;
        let analyser = null;
        let isPlaying = false;
        let pollingInterval = null;
        let websocket = null;

        // Auto-detect client IP and build stream URL
        function detectStreamUrl() {
            fetch('/api/network')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.clients && data.clients.length > 0) {
                        const clientIP = data.clients[0]; // Use first available client
                        const streamUrl = `https://${window.location.host}/client/${clientIP}/stream`;
                        document.getElementById('streamUrl').textContent = streamUrl;
                        checkStreamStatus(streamUrl);
                    } else {
                        document.getElementById('streamUrl').textContent = 'No active clients found';
                        logDebug('No active clients detected');
                    }
                })
                .catch(error => {
                    logDebug('Error detecting client IP: ' + error);
                    // Fallback to manual URL
                    const fallbackUrl = `https://${window.location.host}/client/192.168.188.28/stream`;
                    document.getElementById('streamUrl').textContent = fallbackUrl;
                    checkStreamStatus(fallbackUrl);
                });
        }

        function checkStreamStatus(url) {
            fetch(url, { method: 'HEAD' })
                .then(response => {
                    if (response.ok) {
                        document.getElementById('streamStatus').textContent = `‚úÖ Active (${response.status})`;
                        document.getElementById('streamStatus').style.color = '#4CAF50';
                    } else {
                        document.getElementById('streamStatus').textContent = `‚ùå Inactive (${response.status})`;
                        document.getElementById('streamStatus').style.color = '#f44336';
                    }
                })
                .catch(error => {
                    document.getElementById('streamStatus').textContent = '‚ùå Error';
                    document.getElementById('streamStatus').style.color = '#f44336';
                    logDebug('Stream status check failed: ' + error);
                });
        }

        function startPlayback() {
            const method = document.querySelector('input[name="method"]:checked').value;
            const streamUrl = document.getElementById('streamUrl').textContent;
            
            if (streamUrl === 'Detecting...' || streamUrl === 'No active clients found') {
                showStatus('Please wait for stream detection or refresh', 'error');
                return;
            }

            logDebug(`Starting playback with method: ${method}`);
            
            switch(method) {
                case 'direct':
                    startDirectPlayback(streamUrl);
                    break;
                case 'websocket':
                    startWebSocketPlayback();
                    break;
                case 'polling':
                    startPollingPlayback(streamUrl);
                    break;
            }
        }

        function startDirectPlayback(url) {
            const audioPlayer = document.getElementById('audioPlayer');
            audioPlayer.src = url;
            audioPlayer.style.display = 'block';
            
            audioPlayer.onloadstart = () => logDebug('Direct playback: Loading started');
            audioPlayer.oncanplay = () => logDebug('Direct playback: Can play');
            audioPlayer.onplay = () => {
                showStatus('Direct playback started', 'success');
                setPlaybackState(true);
            };
            audioPlayer.onerror = (e) => {
                logDebug('Direct playback error: ' + JSON.stringify(e));
                showStatus('Direct playback failed', 'error');
            };
            
            audioPlayer.play().catch(error => {
                logDebug('Play promise rejected: ' + error);
                showStatus('Playback start failed: ' + error.message, 'error');
            });
        }

        function startWebSocketPlayback() {
            // WebSocket implementation for real-time streaming
            const wsUrl = `wss://${window.location.host}/ws/audio-stream`;
            websocket = new WebSocket(wsUrl);
            
            websocket.onopen = () => {
                logDebug('WebSocket connected for audio streaming');
                showStatus('WebSocket audio stream connected', 'success');
                setPlaybackState(true);
            };
            
            websocket.onmessage = (event) => {
                // Handle incoming audio data
                logDebug('Received WebSocket audio data: ' + event.data.length + ' bytes');
            };
            
            websocket.onerror = (error) => {
                logDebug('WebSocket error: ' + error);
                showStatus('WebSocket connection failed', 'error');
            };
        }

        function startPollingPlayback(url) {
            // HTTP polling method for older browsers
            logDebug('Starting HTTP polling playback');
            
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            pollingInterval = setInterval(() => {
                fetch(url)
                    .then(response => response.arrayBuffer())
                    .then(buffer => {
                        if (buffer.byteLength > 0) {
                            logDebug(`Polling received ${buffer.byteLength} bytes`);
                            // Process audio buffer here
                        }
                    })
                    .catch(error => logDebug('Polling error: ' + error));
            }, 100); // Poll every 100ms
            
            showStatus('HTTP polling playback started', 'success');
            setPlaybackState(true);
        }

        function stopPlayback() {
            const audioPlayer = document.getElementById('audioPlayer');
            audioPlayer.pause();
            audioPlayer.src = '';
            audioPlayer.style.display = 'none';
            
            if (websocket) {
                websocket.close();
                websocket = null;
            }
            
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
            
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            
            showStatus('Playback stopped', 'info');
            setPlaybackState(false);
            logDebug('All playback stopped');
        }

        function refreshStream() {
            stopPlayback();
            detectStreamUrl();
            showStatus('Stream refreshed', 'info');
        }

        function setPlaybackState(playing) {
            isPlaying = playing;
            document.getElementById('playBtn').disabled = playing;
            document.getElementById('stopBtn').disabled = !playing;
        }

        function showStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            logDebug(`Status: ${message}`);
        }

        function logDebug(message) {
            const debugLog = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            debugLog.innerHTML += `[${timestamp}] ${message}<br>`;
            debugLog.scrollTop = debugLog.scrollHeight;
        }

        // Initialize on page load
        window.onload = () => {
            detectStreamUrl();
            logDebug('PIMIC Audio Player initialized');
        };
    </script>
</body>
</html>