<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIMIC Web Audio Player</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        .player-controls {
            text-align: center;
            margin: 30px 0;
        }
        .big-button {
            font-size: 18px;
            padding: 15px 30px;
            margin: 10px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .play-btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }
        .stop-btn {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            color: white;
        }
        .info-btn {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
        }
        .big-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.2);
        }
        .big-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .status {
            text-align: center;
            padding: 15px;
            margin: 20px 0;
            border-radius: 10px;
            font-weight: bold;
        }
        .status.success { background: rgba(76, 175, 80, 0.3); }
        .status.error { background: rgba(244, 67, 54, 0.3); }
        .status.info { background: rgba(33, 150, 243, 0.3); }
        .visualizer {
            width: 100%;
            height: 100px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin: 20px 0;
        }
        .volume-control {
            margin: 20px 0;
            text-align: center;
        }
        .volume-slider {
            width: 300px;
            height: 10px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            outline: none;
        }
        .stream-info {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .log {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé§ PIMIC Web Audio Player</h1>
        
        <div class="stream-info">
            <h3>üì° Stream Information</h3>
            <p><strong>Client IP:</strong> <span id="clientIP">Detecting...</span></p>
            <p><strong>Stream URL:</strong> <span id="streamURL">Loading...</span></p>
            <p><strong>Status:</strong> <span id="streamStatus">Checking...</span></p>
            <p><strong>Buffer Size:</strong> <span id="bufferSize">0 KB</span></p>
        </div>

        <div class="player-controls">
            <button id="playBtn" class="big-button play-btn" onclick="startAudioStream()">
                ‚ñ∂Ô∏è Start Audio Stream
            </button>
            <button id="stopBtn" class="big-button stop-btn" onclick="stopAudioStream()" disabled>
                ‚èπÔ∏è Stop Stream
            </button>
            <button class="big-button info-btn" onclick="checkStreamInfo()">
                üîÑ Refresh Info
            </button>
        </div>

        <div class="volume-control">
            <label for="volumeSlider">üîä Volume: <span id="volumeValue">50%</span></label><br>
            <input type="range" id="volumeSlider" class="volume-slider" min="0" max="100" value="50" oninput="updateVolume(this.value)">
        </div>

        <canvas id="visualizer" class="visualizer" width="800" height="100"></canvas>

        <div id="status" class="status info">
            Ready to stream audio. Click "Start Audio Stream" to begin.
        </div>

        <div class="log" id="logContainer"></div>
    </div>

    <script>
        let audioContext = null;
        let sourceNode = null;
        let gainNode = null;
        let analyser = null;
        let isStreaming = false;
        let streamInterval = null;
        let visualizerAnimation = null;

        // Initialize page
        window.onload = function() {
            checkStreamInfo();
            log('PIMIC Web Audio Player initialized');
        };

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML += `[${timestamp}] ${message}<br>`;
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(message);
        }

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            log(`Status: ${message}`);
        }

        async function checkStreamInfo() {
            log('Checking stream information...');
            
            try {
                const response = await fetch('/api/streams');
                const data = await response.json();
                
                if (data.success && data.streams.length > 0) {
                    const stream = data.streams[0];
                    document.getElementById('clientIP').textContent = stream.client_ip;
                    document.getElementById('streamURL').textContent = stream.stream_url.replace('http:', 'https:');
                    document.getElementById('streamStatus').textContent = stream.is_active ? '‚úÖ Active' : '‚ùå Inactive';
                    
                    log(`Found active stream for client: ${stream.client_ip}`);
                    updateStatus('Stream information loaded', 'success');
                } else {
                    document.getElementById('clientIP').textContent = 'No active clients';
                    document.getElementById('streamURL').textContent = 'No stream available';
                    document.getElementById('streamStatus').textContent = '‚ùå No streams';
                    
                    log('No active streams found');
                    updateStatus('No active audio streams found', 'error');
                }
            } catch (error) {
                log(`Error checking stream info: ${error.message}`);
                updateStatus('Failed to load stream information', 'error');
            }
        }

        async function startAudioStream() {
            log('Starting audio stream...');
            
            const clientIP = document.getElementById('clientIP').textContent;
            if (clientIP === 'No active clients' || clientIP === 'Detecting...') {
                updateStatus('No active client found. Please refresh info.', 'error');
                return;
            }

            try {
                // Initialize Web Audio API
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Create audio nodes
                gainNode = audioContext.createGain();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                
                // Connect nodes
                gainNode.connect(analyser);
                analyser.connect(audioContext.destination);
                
                // Set initial volume
                gainNode.gain.value = 0.5;
                
                log('Web Audio API initialized');
                
                // Start streaming
                isStreaming = true;
                document.getElementById('playBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                
                // Start fetching audio data
                startAudioFetch(clientIP);
                
                // Start visualizer
                startVisualizer();
                
                updateStatus('Audio streaming started', 'success');
                
            } catch (error) {
                log(`Error starting audio stream: ${error.message}`);
                updateStatus('Failed to start audio stream', 'error');
            }
        }

        function startAudioFetch(clientIP) {
            const streamURL = `https://${window.location.host}/client/${clientIP}/stream`;
            
            streamInterval = setInterval(async () => {
                if (!isStreaming) return;
                
                try {
                    const response = await fetch(streamURL);
                    if (response.ok) {
                        const arrayBuffer = await response.arrayBuffer();
                        
                        if (arrayBuffer.byteLength > 0) {
                            // Update buffer size display
                            const bufferSizeKB = (arrayBuffer.byteLength / 1024).toFixed(1);
                            document.getElementById('bufferSize').textContent = `${bufferSizeKB} KB`;
                            
                            // For now, we'll just log the data since processing raw WebM requires more complex handling
                            log(`Received ${arrayBuffer.byteLength} bytes of audio data`);
                            
                            // In a real implementation, you'd decode the audio data here
                            // and play it through the Web Audio API
                        }
                    } else {
                        log(`Stream fetch failed: ${response.status}`);
                    }
                } catch (error) {
                    log(`Stream fetch error: ${error.message}`);
                }
            }, 100); // Fetch every 100ms
        }

        function stopAudioStream() {
            log('Stopping audio stream...');
            
            isStreaming = false;
            
            if (streamInterval) {
                clearInterval(streamInterval);
                streamInterval = null;
            }
            
            if (visualizerAnimation) {
                cancelAnimationFrame(visualizerAnimation);
                visualizerAnimation = null;
            }
            
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            
            document.getElementById('playBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('bufferSize').textContent = '0 KB';
            
            // Clear visualizer
            const canvas = document.getElementById('visualizer');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            updateStatus('Audio streaming stopped', 'info');
        }

        function updateVolume(value) {
            document.getElementById('volumeValue').textContent = `${value}%`;
            if (gainNode) {
                gainNode.gain.value = value / 100;
            }
        }

        function startVisualizer() {
            const canvas = document.getElementById('visualizer');
            const ctx = canvas.getContext('2d');
            
            function draw() {
                if (!isStreaming || !analyser) return;
                
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                analyser.getByteFrequencyData(dataArray);
                
                ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                const barWidth = (canvas.width / bufferLength) * 2.5;
                let barHeight;
                let x = 0;
                
                for (let i = 0; i < bufferLength; i++) {
                    barHeight = (dataArray[i] / 255) * canvas.height;
                    
                    const r = barHeight + 25 * (i / bufferLength);
                    const g = 250 * (i / bufferLength);
                    const b = 50;
                    
                    ctx.fillStyle = `rgb(${r},${g},${b})`;
                    ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                    
                    x += barWidth + 1;
                }
                
                visualizerAnimation = requestAnimationFrame(draw);
            }
            
            draw();
        }
    </script>
</body>
</html>